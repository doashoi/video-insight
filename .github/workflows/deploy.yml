name: 🚀 部署视频分析机器人到阿里云函数计算

on:
  push:
    branches: [main]  # 推送到 main 分支时自动触发部署
  workflow_dispatch:  # 允许在 GitHub Actions 界面手动触发部署

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # 预留充足时间用于 PyTorch 镜像构建

    steps:
      # =============== 1. 代码检出 ===============
      - name: 📥 检出代码仓库
        uses: actions/checkout@v4

      # =============== 2. Docker 环境准备 ===============
      - name: 🐳 配置 Docker Buildx（启用构建缓存加速）
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:master
            env.BUILDKIT_PROGRESS=plain

      # =============== 3. ACR 登录（关键修复：Personal CR 专属域名） ===============
      - name: 🔑 登录阿里云容器镜像服务 (Personal CR)
        run: |
          # 重要说明：
          # - 用户名：必须使用阿里云账号名（如 nick6911659316），不是 AccessKey ID！
          # - 密码：使用 RAM 子账号的 AccessKey Secret
          # - 域名：必须使用 Personal CR 专属域名（非标准 registry.cn-hangzhou.aliyuncs.com）
          echo "${{ secrets.ALIYUN_PASSWORD }}" | docker login \
            --username="${{ secrets.ALIYUN_ACCOUNT_ID }}" \
            --password-stdin \
            ${{ secrets.ACR_REGISTRY_URL }}

      # =============== 4. 构建并推送容器镜像 ===============
      - name: 🏗️ 构建并推送 Docker 镜像到 Personal CR
        uses: docker/build-push-action@v5
        with:
          context: .  # 使用当前目录作为构建上下文
          push: true  # 构建完成后自动推送
          platforms: linux/amd64  # 关键修复：强制构建 linux/amd64 镜像，解决 FC 3.0 "platform unknown" 报错
          # 关键修复：使用专属域名 + 命名空间 + 镜像名
          tags: |
            ${{ secrets.ACR_REGISTRY_URL }}/${{ secrets.ACR_NAMESPACE }}/video-insight:${{ github.sha }}
            ${{ secrets.ACR_REGISTRY_URL }}/${{ secrets.ACR_NAMESPACE }}/video-insight:latest
          # 关键修复：强制输出标准 OCI Manifest，包含完整架构元数据
          outputs: type=image,oci-mediatypes=true,push-by-digest=true,name-canonical=true
          cache-from: type=gha  # 从 GitHub Actions 缓存加载层
          cache-to: type=gha,mode=max  # 将新层保存到缓存
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}

      # =============== 4.1 镜像架构防御性校验 (Fail Fast) ===============
      - name: 🛡️ 验证镜像 Manifest (确保架构为 amd64)
        run: |
          # 安装 crane 工具 (Google 容器注册表工具)
          curl -sL "https://github.com/google/go-containerregistry/releases/download/v0.19.0/go-containerregistry_Linux_x86_64.tar.gz" | tar -xz -C /usr/local/bin crane
          
          echo "🔍 正在检查镜像架构..."
          IMAGE_URI="${{ secrets.ACR_REGISTRY_URL }}/${{ secrets.ACR_NAMESPACE }}/video-insight:${{ github.sha }}"
          
          # 使用 crane 获取 manifest 配置
          # 注意：需要传递认证信息
          export CRANE_USERNAME="${{ secrets.ALIYUN_ACCOUNT_ID }}"
          export CRANE_PASSWORD="${{ secrets.ALIYUN_PASSWORD }}"
          
          # 登录
          echo "${{ secrets.ALIYUN_PASSWORD }}" | crane auth login ${{ secrets.ACR_REGISTRY_URL }} -u "${{ secrets.ALIYUN_ACCOUNT_ID }}" --password-stdin
          
          # 获取架构信息
          ARCH=$(crane config "$IMAGE_URI" | grep -o '"architecture":"[^"]*"' | cut -d'"' -f4)
          
          echo "✅ 检测到镜像架构: $ARCH"
          
          if [ "$ARCH" != "amd64" ]; then
            echo "❌ 严重错误: 镜像架构不是 amd64 (检测值: $ARCH)"
            echo "   FC 3.0 无法运行非 amd64 镜像，部署已终止以节省时间。"
            exit 1
          fi
          echo "🎉 镜像架构校验通过！"

      # =============== 5. 安装 Serverless Devs（阿里云函数计算 CLI） ===============
      - name: ⚙️ 安装 Serverless Devs 工具
        run: |
          npm install -g @serverless-devs/s@latest
          # 验证安装
          s -v

      # =============== 6. 配置阿里云凭证 ===============
      - name: 🔐 配置 Serverless Devs 凭证
        run: |
          # 注意：AccountID 参数留空（-）让工具自动获取，避免错误
          s config add -a default -f \
            --AccessKeyID "${{ secrets.ALIYUN_ACCESS_KEY_ID }}" \
            --AccessKeySecret "${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}"

      # =============== 7. 动态生成部署配置（安全注入环境变量） ===============
      - name: 📝 生成函数计算部署配置 (s.yaml)
        run: |
          # 创建 s.yaml 配置文件（适配 FC 3.0）
          cat > s.yaml <<EOF
          edition: 3.0.0
          name: video-insight
          access: default
          
          resources:
            video-insight:
              component: fc3
              props:
                region: cn-hangzhou
                functionName: bot-processor
                description: "Video Insight Bot (FC 3.0)"
                runtime: custom-container
                timeout: 900
                memorySize: 4096
                instanceConcurrency: 1
                internetAccess: true
                customContainerConfig:
                  image: "${{ secrets.ACR_REGISTRY_URL }}/${{ secrets.ACR_NAMESPACE }}/video-insight:${{ github.sha }}"
                  port: 9000
                  accelerationType: 'None'  # 显式关闭镜像加速 (加引号确保生效)，解决 optimization pending 卡死问题
                environmentVariables:
                  # 飞书机器人配置
                  FEISHU_APP_ID: "${{ secrets.FEISHU_APP_ID }}"
                  FEISHU_APP_SECRET: "${{ secrets.FEISHU_APP_SECRET }}"
                  FEISHU_VERIFICATION_TOKEN: "${{ secrets.FEISHU_VERIFICATION_TOKEN }}"
                  FEISHU_ENCRYPT_KEY: "${{ secrets.FEISHU_ENCRYPT_KEY }}"
                  # AI Model Config
                  DASHSCOPE_API_KEY: "${{ secrets.DASHSCOPE_API_KEY }}"
                  # 其他配置
                  TEMP_CLEANUP_ENABLED: "true"
                  PYTHONUNBUFFERED: "1"
                # 暂时注释掉日志配置，以修复 SLS Project 不存在的问题 (方案 B)
                # logConfig:
                #   project: video-insight-logs
                #   logstore: function-log
                #   enableRequestMetrics: true
                #   enableInstanceMetrics: true
                triggers:
                  - triggerName: http-trigger
                    triggerType: http
                    triggerConfig:
                      authType: anonymous
                      methods:
                        - POST
          EOF
          
          # 关键优化：将公网镜像地址替换为 VPC 内网地址 (registry-vpc)，加速 FC 拉取并避免超时
          # 注意：仅当 Region 为 cn-hangzhou 时有效，且 FC 与 ACR 在同一地域
          # 优化正则：同时兼容标准版 (registry.cn-hangzhou...) 和 个人版专属域名 (...cn-hangzhou.cr.aliyuncs.com)
          sed -i 's|registry.cn-hangzhou.aliyuncs.com|registry-vpc.cn-hangzhou.aliyuncs.com|g' s.yaml
          sed -i 's|\.cn-hangzhou\.cr\.aliyuncs\.com|-vpc.cn-hangzhou.cr.aliyuncs.com|g' s.yaml
          
          echo "✅ 生成的 s.yaml 配置："
          cat s.yaml | grep -v "FEISHU_APP_SECRET\|FEISHU_ENCRYPT_KEY" || true

      # =============== 8. 部署到函数计算 ===============
      - name: 🚀 部署到阿里云函数计算 (FC 3.0)
        id: deploy
        run: |
          # 开启 pipefail，确保管道命令中任何一个环节失败都会导致整个步骤失败
          set -e
          set -o pipefail
          
          echo "🔧 开始部署函数计算服务..."
          s deploy --use-local -y --debug 2>&1 | tee deploy.log
          
          # 提取 FC 3.0 的 Trigger URL
          # 尝试从日志中匹配 .fcapp.run 的 URL
          if grep -q "fcapp.run" deploy.log; then
            # 提取包含 https 和 fcapp.run 的行，并清洗
            TRIGGER_URL=$(grep -o 'https://[^[:space:]]*\.fcapp\.run' deploy.log | head -n 1)
            
            if [ -n "$TRIGGER_URL" ]; then
              echo "trigger_url=${TRIGGER_URL}" >> $GITHUB_OUTPUT
              echo "✅ HTTP 触发器创建成功: ${TRIGGER_URL}"
            else
              echo "⚠️  找到 fcapp.run 但无法提取完整 URL，请检查日志"
              echo "trigger_url=未找到" >> $GITHUB_OUTPUT
            fi
          else
            echo "⚠️  未在日志中找到触发器 URL"
            echo "trigger_url=未找到" >> $GITHUB_OUTPUT
          fi

      # =============== 9. 部署结果摘要 ===============
      - name: ✅ 部署完成摘要
        run: |
          echo "=========================================="
          echo "✅ 视频分析机器人部署成功！"
          echo "=========================================="
          echo "📦 镜像地址: ${{ secrets.ACR_REGISTRY_URL }}/${{ secrets.ACR_NAMESPACE }}/video-insight:${{ github.sha }}"
          echo "🔧 服务名称: video-insight"
          echo "🤖 函数名称: bot-processor"
          echo "🔗 Webhook 地址: ${{ steps.deploy.outputs.trigger_url }}"
          echo "   （如显示'未找到'，请登录阿里云控制台查看：函数计算 → 服务/函数 → 触发器）"
          echo "⏰ 部署完成时间: $(date +'%Y-%m-%d %H:%M:%S CST')"
          echo "=========================================="
          echo ""
          echo "📌 下一步操作："
          echo "1. 复制上方 Webhook 地址"
          echo "2. 登录飞书开放平台 → 你的应用 → 事件与回调"
          echo "3. 将 URL 填入【请求网址URL】字段"
          echo "4. 确保已订阅事件：接收消息、消息已读、卡片互动"