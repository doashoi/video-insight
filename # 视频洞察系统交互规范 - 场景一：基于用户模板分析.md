# 视频洞察系统交互规范 - 场景一：基于用户模板分析

本文档详细描述了当用户提供预设飞书多维表格模板时，系统的交互流程与逻辑处理规范。

## 1. 流程概览
1. **动态解析阶段**：实时调用飞书 API 抓取模板所有字段、类型及预设选项（Options）。**严禁硬编码任何业务字段。**
2. **AI 推理阶段**：AI 对字段进行语义解读，并针对“选项为空”的单选/多选字段，基于首个素材自动推导出推荐选项。
3. **无状态确认阶段**：发送飞书消息卡片。所有分析逻辑与配置均加密压缩在卡片按钮的 Payload 中，后端不存储临时状态。
4. **互动微调阶段**：处理 unresolved 字段，支持通过自然语言补充 `user_logic` 或定义新的选项。
5. **执行阶段**：用户点击“确认”后，Payload 随请求带回，后端立即启动全量分析。

## 2. 字段处理与选项推理原则

### 2.1 选项优先级逻辑 (Options Priority)
*   **最高优先级**：用户在飞书表格中预设的选项（API 直接读取）。
*   **次高优先级**：用户在确认阶段通过自然语言补充的选项（如“选项：A, B, C”）。
*   **兜底优先级**：若字段类型为单选/多选但选项为空，AI 将基于 1-2 个视频样本**自主推理**出一套选项，并展示在确认卡片中供用户确认。

### 2.2 严格模板一致性 (Strict Adherence)
*   **原则**：在场景一中，机器人必须**严格遵守**现有表头。
*   **边界**：机器人的主动性集中在“如何准确填充现有字段”及“为现有空选项字段提供推理建议”。

## 3. 技术方案：无状态 Payload 交互
为了确保系统在云函数（FC）环境下的极致轻量与高可用，采用以下方案：
*   **上下文随身带**：确认卡片中的“开始分析”按钮包含完整的 `config_payload`（包含字段逻辑、推理选项、user_logic）。
*   **零数据库依赖**：后端无需维护“任务进行中”的状态，每次点击都是一次完整的自包含指令。
*   **可重入性**：用户可以随时点击历史卡片重启任务，配置依然有效。

### 2.2 字段分类与处理逻辑

### A. 可自动分析字段 (Auto-Analyzable)
*   **特征**：语义明确（如受众、概述、痛点、点击率建议）。
*   **处理**：AI 自动生成“分析方案”及“输出示例”。
*   **交互**：用户可要求修改风格（如：“概述写得简练一点”）。

### B. 无法自动解析字段 (Unresolved Fields)
*   **特征**：业务私有或无语义关联（如负责人、审核状态、项目归属）。
*   **处理**：系统通过黄色警告标记，默认示例为 `(默认留空)`。
*   **交互**：用户需通过对话定义逻辑。

## 3. 动态配置规则 (Natural Language Commands)

### 字段类型与选项定义
*   **用户输入示例**：`负责人字段，设为单选，选项：张三，李四`
*   **系统响应**：
    1.  调用飞书 API 更新/创建该字段属性，写入选项。
    2.  刷新确认卡片，展示最新状态。

### 数据分配逻辑 (Assignment Logic)
*   **默认状态**：除非用户明确指令，否则无法解析字段保持为空。
*   **手动模式**：用户回复 `先不要填，我自己来`。AI 分析时该字段填入 `null`。
*   **条件模式**：用户回复 `功能是“月暖暖”的都填张三`。AI 执行条件判定填充。
*   **全自动模式**：用户回复 `AI 随机分配` 或 `AI 根据视频风格分配`。

## 4. 确认卡片结构 (Message Card V3)

| 字段名 | 字段类型 | 逻辑解读 | 输出示例 (基于真实素材) |
| :--- | :--- | :--- | :--- |
| **人群** | 🟢 单选 | 视觉匹配受众 | `年轻女性 (职场白领)` |
| **概述** | 📝 文本 | 描述剧情走向 | `女主在工位使用产品后露出笑容。` |
| **负责人** | 🟡 单选 | **(未分配逻辑)** | `(默认留空)` |

## 6. 主动追问与需求确认机制 (Proactive Clarification)

机器人不仅是被动接收者，必须在以下模糊场景下主动发起追问，确保理解意图：

### 6.1 语义歧义追问
*   **触发条件**：字段名存在多种解释（如“等级”可指质量、受众或推荐度）。
*   **动作**：停止解析，列出可能的维度请用户确认，或询问“您希望这个字段分析视频的哪个方面？”。

### 6.2 指令完整性校验
*   **触发条件**：用户定义了选项（如“负责人：张三、李四”）但未指定分配逻辑。
*   **动作**：主动追问分配规则。提供选项：
    1. AI 自动匹配逻辑。
    2. 暂时留空，用户后续手动填写。
    3. 根据特定条件（如视频功能）进行关联分配。

### 6.3 类型冲突保护
*   **触发条件**：飞书字段类型（如数字）与 AI 解析逻辑（如自然语言描述）冲突。
*   **动作**：提示冲突，询问用户是“修改飞书字段类型”还是“让 AI 强行适配（如打分/提取数字）”。

### 6.4 负向指令确认
*   **触发条件**：用户回复“先不要填”、“我自己来”等。
*   **动作**：确认该字段在本次任务中将保持为空，但保留飞书端的选项配置。