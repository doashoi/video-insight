# 视频洞察分析项目说明 (Video Insight Project Documentation)

## 1. 项目概述 (Project Overview)
本项目旨在自动化处理短视频分析任务。通过飞书机器人与长连接（WebSocket）交互，自动化下载指定多维表格中的视频、提取音频、进行语音识别 (ASR)、AI 关键信息提取，并将最终分析结果同步到新创建的飞书多维表格中。

**核心价值**:
- **ChatOps 体验**: 像聊天一样发送指令或填写卡片即可启动复杂分析任务。
- **无需公网 IP**: 采用 WebSocket 长连接技术，本地部署无需内网穿透，安全稳定。
- **自动化闭环**: 从读取源数据到生成分析结果表格，全流程自动化。
- **数据归属**: 生成的表格永久归属企业自建应用，管理员权限自动分配给任务发起人。

## 2. 理想运行流程 (Ideal Running Flow)

### 步骤 1: 唤起机器人
用户在飞书客户端（PC/手机）打开“视频洞察助手”机器人对话框。
- **动作**: 发送关键词 “分析”、“Start” 或 “Menu”。
- **反馈**: 机器人回复一张**任务配置卡片**。

### 2. 配置分析任务
用户在卡片中填写参数：
1.  **源多维表格链接**: 粘贴包含视频素材的飞书多维表格 URL。
2.  **新任务名称**: 为本次分析结果表格命名（如“竞品分析_Q1”）。
3.  **目标文件夹 Token** (可选): 指定结果表格存放的位置。
4.  **动作**: 点击卡片上的 **“🚀 开始分析”** 按钮。

### 3. 后端自动化执行
本地运行的 `bot.py` 通过 WebSocket 收到卡片交互事件 (`card.action.trigger`)。
1.  **校验**: 检查链接有效性，确认当前无其他任务正在运行（全局锁）。
2.  **反馈**: 立即回复“✅ 任务已启动，请耐心等待...”。
3.  **执行管线**:
    -   **解析源**: 从源表格链接中解析 `app_token` 和 `table_id`。
    -   **创建新表**: 自动创建新的多维表格应用，并将当前用户设为管理员。
    -   **下载视频**: 根据源表格中的视频链接，增量下载视频到本地。
    -   **AI 分析**: 进行本地 VAD/ASR 识别和 AI 内容分析。
    -   **数据同步**: 将分析结果回写到新创建的表格中。

### 4. 结果通知
任务完成后，机器人自动发送一条完成消息，包含新表格的链接。

---

## 3. 部署指南 (Deployment Guide)

### 3.1 环境准备
1.  **操作系统**: Windows (推荐，支持 CUDA 加速) / Linux / macOS。
2.  **Python 环境**: 建议使用 `uv` 管理。
    ```bash
    uv sync
    ```
3.  **依赖工具**:
    -   **FFmpeg**: 需安装并添加到系统 PATH。
    -   **CUDA** (可选): 推荐使用 NVIDIA 显卡加速 FunASR。

### 3.2 配置文件 (.env)
在项目根目录创建 `.env` 文件：
```ini
DASHSCOPE_API_KEY=sk-xxxxxx
FEISHU_APP_ID=cli_xxxxxx
FEISHU_APP_SECRET=xxxxxx
# FEISHU_DOMAIN=https://open.feishu.cn
```

### 3.3 飞书开发者后台配置
1.  **创建企业自建应用**: 进入 [飞书开放平台](https://open.feishu.cn/app)。
2.  **权限配置**:
    -   **多维表格**: `bitable:app:read`, `bitable:app:write`。
    -   **云文档**: `drive:drive:read`, `drive:file:create`。
    -   **机器人**: `im:message`, `im:message:send_as_bot`。
    -   **通讯录**: `contact:contact:read_as_app`。
3.  **事件订阅 (关键)**:
    -   进入 **事件订阅** -> **配置订阅方式**。
    -   选择 **“长连接模式”** (WebSocket)，无需配置请求网址。
    -   添加事件:
        -   `im.message.receive_v1` (接收消息)
        -   `card.action.trigger` (卡片交互)
4.  **发布版本**: 创建并发布应用版本，确保权限生效。

### 3.4 启动服务
使用 `uv` 运行机器人服务：
```bash
uv run bot.py
```
看到日志显示 `Starting Feishu WebSocket Client...` 即表示连接成功。

---

## 4. 风险评估与规避 (Risk Assessment)

| 环节 | 风险点 | 规避/解决方案 |
| :--- | :--- | :--- |
| **网络** | **网络波动导致断连** | **规避**: 飞书 SDK 内置了自动重连机制 (Auto-Reconnect)。本地网络恢复后会自动重新上线。 |
| **并发** | **资源过载** (多人同时点击) | **规避**: 已实现 `TASK_LOCK` 全局锁。当一个任务正在运行时，后续请求会收到“系统忙碌”提示，不会导致显卡崩溃。 |
| **输入** | **错误的源链接** | **规避**: 代码中增加了 URL 解析容错逻辑，若无法解析 Token，机器人会提示用户检查链接格式。 |
| **存储** | **磁盘空间不足** | **规避**: 建议定期手动清理 `output` 目录下的旧视频文件。 |

---

## 5. 维护与扩展
- **修改卡片样式**: 编辑 `bot.py` 中的 `send_config_card` 函数 JSON 结构。
- **新增分析维度**: 修改 `feishu_syncer.py` 的 `init_table_fields` 和 `ai_analyzer.py` 的 `_get_system_prompt`。
